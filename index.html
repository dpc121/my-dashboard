<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Secure Website Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#020617">

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#e5e7eb}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:#020617;padding:15px;border-radius:10px;margin-bottom:15px}
input,select,button{padding:8px;margin:4px;border-radius:6px;border:none}
input,select{background:#020617;color:#fff;border:1px solid #334155}
button{background:#2563eb;color:#fff;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #334155;padding:6px;text-align:center;vertical-align:top}
th{background:#020617}
.hide{display:none}
.btn{padding:5px 8px;font-size:12px}
.red{background:#dc2626}
.green{background:#16a34a}
.gray{background:#475569}
.copy{cursor:pointer;color:#38bdf8}
.small{font-size:12px;color:#94a3b8}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div class="card" id="loginBox">
<h2>üîê Admin Login</h2>
<input id="luser" placeholder="Username">
<input id="lpass" type="password" placeholder="Password">
<label class="small">
<input type="checkbox" id="rememberMe"> Remember Me (30 Days)
</label><br>
<button onclick="login()">Login / Register</button>
</div>

<!-- DASHBOARD -->
<div class="card hide" id="dash">
<h2>üìå Website Manager (GitHub Base)</h2>

<div class="card">
<h3 id="formTitle">‚ûï Add Website</h3>
<input id="site" placeholder="Website Name">
<input id="url" placeholder="Website URL">
<input id="uid" placeholder="User ID">

<select id="cat" onchange="togglePwdFields()">
<option>Govt</option>
<option>Job</option>
<option>Bank</option>
<option>Other</option>
</select>

<div id="pwdBlock">
<input id="pwd1" placeholder="Login Password">
<input id="pwd2" class="hide" placeholder="Profile Password">
<input id="pwd3" class="hide" placeholder="Transaction Password">
</div>

<button onclick="saveEntry()" id="saveBtn">Save</button>
<button class="gray hide" id="cancelBtn" onclick="cancelEdit()">Cancel</button>
</div>

<input placeholder="üîç Search" onkeyup="search(this.value)">
<table id="tbl"></table>

<button class="red" onclick="logout()">Logout</button>
</div>

</div>

<script>
/* ===== ENCRYPT ===== */
const enc=t=>btoa(unescape(encodeURIComponent(t)));
const dec=t=>decodeURIComponent(escape(atob(t)));

let currentUser=null;
let sites=[];
let editIndex=null;

/* ===== AUTO LOGIN ===== */
window.onload=()=>{
  let u=localStorage.getItem("rememberUser");
  let t=localStorage.getItem("rememberTime");
  if(u && t && (Date.now()-t)/(1000*60*60*24)<=30){
    currentUser=u;
    sites=JSON.parse(localStorage.getItem("sites_"+u)||"[]");
    loginBox.classList.add("hide");
    dash.classList.remove("hide");
    render();
  }
};

/* ===== LOGIN ===== */
function login(){
  let u=luser.value.trim(), p=lpass.value.trim();
  if(!u||!p) return alert("Fill all");
  let users=JSON.parse(localStorage.getItem("users")||"{}");
  if(!users[u]) users[u]=enc(p);
  if(dec(users[u])!==p) return alert("Wrong password");
  currentUser=u;
  localStorage.setItem("users",JSON.stringify(users));
  sites=JSON.parse(localStorage.getItem("sites_"+u)||"[]");
  if(rememberMe.checked){
    localStorage.setItem("rememberUser",u);
    localStorage.setItem("rememberTime",Date.now());
  }
  loginBox.classList.add("hide");
  dash.classList.remove("hide");
  render();
}

/* ===== LOGOUT ===== */
function logout(){
  localStorage.removeItem("rememberUser");
  localStorage.removeItem("rememberTime");
  location.reload();
}

/* ===== CATEGORY ===== */
function togglePwdFields(){
  pwd2.classList.toggle("hide",!(cat.value==="Job"||cat.value==="Bank"));
  pwd3.classList.toggle("hide",!(cat.value==="Job"||cat.value==="Bank"));
}

/* ===== SAVE / UPDATE ===== */
function saveEntry(){
  let data={
    site:site.value,
    url:url.value,
    uid:enc(uid.value),
    cat:cat.value,
    pwd1:enc(pwd1.value),
    pwd2:enc(pwd2.value||""),
    pwd3:enc(pwd3.value||"")
  };

  if(editIndex!==null){
    sites[editIndex]=data;   // ‚úÖ UPDATE
    editIndex=null;
    formTitle.innerText="‚ûï Add Website";
    cancelBtn.classList.add("hide");
  }else{
    sites.push(data);        // ‚ûï ADD
  }

  persist();
  clearForm();
}

/* ===== EDIT ROW (THIS WAS MISSING EFFECT) ===== */
function editRow(i){
  let d=sites[i];
  editIndex=i;
  formTitle.innerText="‚úè Edit Website";
  site.value=d.site;
  url.value=d.url;
  uid.value=dec(d.uid);
  cat.value=d.cat;
  togglePwdFields();
  pwd1.value=dec(d.pwd1);
  pwd2.value=dec(d.pwd2||"");
  pwd3.value=dec(d.pwd3||"");
  cancelBtn.classList.remove("hide");
  window.scrollTo({top:0,behavior:"smooth"});
}

/* ===== CANCEL EDIT ===== */
function cancelEdit(){
  editIndex=null;
  formTitle.innerText="‚ûï Add Website";
  clearForm();
  cancelBtn.classList.add("hide");
}

/* ===== CLEAR ===== */
function clearForm(){
  site.value=url.value=uid.value=pwd1.value=pwd2.value=pwd3.value="";
}

/* ===== DELETE ===== */
function del(i){
  if(confirm("Delete?")){
    sites.splice(i,1);
    persist();
  }
}

/* ===== SAVE STORAGE ===== */
function persist(){
  localStorage.setItem("sites_"+currentUser,JSON.stringify(sites));
  render();
}

/* ===== SEARCH ===== */
function search(v){
  v=v.toLowerCase();
  [...tbl.rows].forEach((r,i)=>{
    if(i===0)return;
    r.style.display=r.innerText.toLowerCase().includes(v)?"":"none";
  });
}

/* ===== COPY ===== */
const copy=t=>{navigator.clipboard.writeText(t);alert("Copied");};

/* ===== RENDER (EDIT BUTTON CONFIRMED) ===== */
function render(){
  tbl.innerHTML=`
  <tr>
    <th>Website</th>
    <th>User ID</th>
    <th>Passwords</th>
    <th>Action</th>
  </tr>`;
  sites.forEach((d,i)=>{
    tbl.innerHTML+=`
    <tr>
      <td>${d.site}</td>
      <td class="copy" onclick="copy('${dec(d.uid)}')">${dec(d.uid)}</td>
      <td>
        Login <button class="btn" onclick="copy('${dec(d.pwd1)}')">Copy</button><br>
        ${d.pwd2?`Profile <button class="btn" onclick="copy('${dec(d.pwd2)}')">Copy</button><br>`:""}
        ${d.pwd3?`Txn <button class="btn" onclick="copy('${dec(d.pwd3)}')">Copy</button>`:""}
      </td>
      <td>
        <button class="btn green" onclick="editRow(${i})">‚úè Edit</button>
        <button class="btn red" onclick="del(${i})">‚ùå</button>
      </td>
    </tr>`;
  });
}

/* ===== PWA ===== */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>
</body>
</html>
