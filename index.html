<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Secure Dashboard (Realtime Sync)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#e5e7eb}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:#020617;padding:15px;border-radius:10px;margin-bottom:15px}
h2,h3{margin:6px 0}
input,select,button{
  padding:8px;margin:4px;border-radius:6px;border:none
}
input,select{
  background:#020617;color:#fff;border:1px solid #334155
}
button{
  background:#2563eb;color:#fff;font-weight:bold;cursor:pointer
}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{
  border:1px solid #334155;
  padding:6px;
  text-align:center;
  vertical-align:top
}
th{background:#020617}
.hide{display:none}
.btn{padding:5px 8px;font-size:12px;margin:2px}
.red{background:#dc2626}
.green{background:#16a34a}
.gray{background:#475569}
.copy{cursor:pointer;color:#38bdf8}
.pass-row{text-align:left}
.pass-row input{width:120px}
.small{font-size:12px;color:#94a3b8}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div class="card" id="loginBox">
<h2>üîê Admin Login</h2>
<input id="luser" placeholder="Username">
<input id="lpass" type="password" placeholder="Password">
<label class="small">
<input type="checkbox" id="rememberMe"> Remember Me (30 days)
</label><br>
<button onclick="login()">Login / Register</button>
<button class="gray" onclick="openForgot()">Forgot Password</button>
</div>

<!-- FORGOT -->
<div class="card hide" id="forgotBox">
<h3>üîÅ Reset Password</h3>
<input id="fpUser" placeholder="Username">
<input id="fpPass" placeholder="New Password">
<button onclick="resetPassword()">Reset</button>
<button class="gray" onclick="closeForgot()">Back</button>
</div>

<!-- DASHBOARD -->
<div class="card hide" id="dash">
<h2 id="formTitle">‚ûï Add Website</h2>

<div class="card">
<input id="site" placeholder="Website Name">
<input id="uid" placeholder="User ID">

<select id="cat" onchange="togglePwdFields()">
<option>Govt</option>
<option>Job</option>
<option>Bank</option>
<option>Other</option>
</select>

<div>
<input id="pwd1" placeholder="Login Password">
<input id="pwd2" class="hide" placeholder="Profile Password">
<input id="pwd3" class="hide" placeholder="Transaction Password">
</div>

<button onclick="saveEntry()">Save</button>
<button class="gray hide" id="cancelBtn" onclick="cancelEdit()">Cancel</button>
</div>

<!-- BACKUP -->
<div class="card">
<button onclick="exportBackup()">üì¶ Export Backup</button>
<input type="file" onchange="importBackup(this.files[0])">
</div>

<input placeholder="üîç Search" onkeyup="search(this.value)">
<table id="tbl"></table>

<button class="red" onclick="logout()">Logout</button>
</div>

</div>

<!-- üî• FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE CONFIG ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCxFQkurXcZE4qImf-49mwBPG6PSyVx4",
  authDomain: "dp-communication.firebaseapp.com",
  projectId: "dp-communication"
});
const db = firebase.firestore();

/* ================= CONSTANT ================= */
const STORAGE_KEY="SECURE_DASHBOARD_DATA_V1";

/* ================= ENCRYPT ================= */
const enc=t=>btoa(unescape(encodeURIComponent(t)));
const dec=t=>decodeURIComponent(escape(atob(t)));

let currentUser=null;
let sites=[];
let editIndex=null;
let unsubscribe=null;

/* ================= LOCAL LOAD ================= */
function loadLocal(){
  const raw=localStorage.getItem(STORAGE_KEY+"_"+currentUser);
  if(raw){
    const p=JSON.parse(raw);
    sites=p.data||[];
  }else sites=[];
}

/* ================= LOCAL SAVE ================= */
function saveLocal(){
  localStorage.setItem(
    STORAGE_KEY+"_"+currentUser,
    JSON.stringify({version:1,data:sites})
  );
}

/* ================= REALTIME SYNC ================= */
function startRealtime(){
  if(unsubscribe) unsubscribe();
  unsubscribe=db.collection("dashboards")
    .doc(currentUser)
    .onSnapshot(doc=>{
      if(doc.exists){
        sites=doc.data().data||[];
        saveLocal();
        render();
      }
    });
}

/* ================= PERSIST ================= */
function persist(){
  saveLocal();
  db.collection("dashboards")
    .doc(currentUser)
    .set({
      version:1,
      data:sites,
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    });
}

/* ================= AUTO LOGIN ================= */
window.onload=()=>{
  let u=localStorage.getItem("rememberUser");
  let t=localStorage.getItem("rememberTime");
  if(u && t && (Date.now()-t)/(1000*60*60*24)<=30){
    currentUser=u;
    loadLocal();
    loginBox.classList.add("hide");
    dash.classList.remove("hide");
    render();
    startRealtime();
  }
};

/* ================= LOGIN ================= */
function login(){
  let u=luser.value.trim(),p=lpass.value.trim();
  if(!u||!p)return alert("Fill all");

  let users=JSON.parse(localStorage.getItem("users")||"{}");
  if(!users[u]) users[u]=enc(p);
  if(dec(users[u])!==p) return alert("Wrong password");

  currentUser=u;
  localStorage.setItem("users",JSON.stringify(users));
  loadLocal();

  if(rememberMe.checked){
    localStorage.setItem("rememberUser",u);
    localStorage.setItem("rememberTime",Date.now());
  }

  loginBox.classList.add("hide");
  forgotBox.classList.add("hide");
  dash.classList.remove("hide");
  render();
  startRealtime();
}

/* ================= LOGOUT ================= */
function logout(){
  localStorage.removeItem("rememberUser");
  localStorage.removeItem("rememberTime");
  location.reload();
}

/* ================= FORGOT ================= */
function openForgot(){
  loginBox.classList.add("hide");
  forgotBox.classList.remove("hide");
}
function closeForgot(){
  forgotBox.classList.add("hide");
  loginBox.classList.remove("hide");
}
function resetPassword(){
  let u=fpUser.value.trim(),p=fpPass.value.trim();
  let users=JSON.parse(localStorage.getItem("users")||"{}");
  if(!users[u])return alert("User not found");
  users[u]=enc(p);
  localStorage.setItem("users",JSON.stringify(users));
  alert("Password reset successful");
  closeForgot();
}

/* ================= CATEGORY ================= */
function togglePwdFields(){
  pwd2.classList.toggle("hide",!(cat.value==="Job"||cat.value==="Bank"));
  pwd3.classList.toggle("hide",!(cat.value==="Job"||cat.value==="Bank"));
}

/* ================= SAVE / UPDATE ================= */
function saveEntry(){
  let d={
    site:site.value,
    uid:enc(uid.value),
    cat:cat.value,
    pwd1:enc(pwd1.value),
    pwd2:enc(pwd2.value||""),
    pwd3:enc(pwd3.value||"")
  };

  if(editIndex!==null){
    sites[editIndex]=d;
    editIndex=null;
    cancelBtn.classList.add("hide");
    formTitle.innerText="‚ûï Add Website";
  }else sites.push(d);

  persist();
  clearForm();
}

/* ================= EDIT ================= */
function editRow(i){
  let d=sites[i];
  editIndex=i;
  formTitle.innerText="‚úè Edit Website";
  site.value=d.site;
  uid.value=dec(d.uid);
  cat.value=d.cat;
  togglePwdFields();
  pwd1.value=dec(d.pwd1);
  pwd2.value=dec(d.pwd2||"");
  pwd3.value=dec(d.pwd3||"");
  cancelBtn.classList.remove("hide");
  window.scrollTo({top:0,behavior:"smooth"});
}

/* ================= CANCEL ================= */
function cancelEdit(){
  editIndex=null;
  formTitle.innerText="‚ûï Add Website";
  clearForm();
  cancelBtn.classList.add("hide");
}

/* ================= CLEAR ================= */
function clearForm(){
  site.value=uid.value=pwd1.value=pwd2.value=pwd3.value="";
}

/* ================= DELETE ================= */
function del(i){
  if(confirm("Delete?")){
    sites.splice(i,1);
    persist();
  }
}

/* ================= SEARCH ================= */
function search(v){
  v=v.toLowerCase();
  [...tbl.rows].forEach((r,i)=>{
    if(i===0)return;
    r.style.display=r.innerText.toLowerCase().includes(v)?"":"none";
  });
}

/* ================= COPY ================= */
const copy=t=>{navigator.clipboard.writeText(t);alert("Copied");};

/* ================= SHOW / HIDE ================= */
function toggleShow(id){
  let el=document.getElementById(id);
  el.type=el.type==="password"?"text":"password";
}

/* ================= EXPORT / IMPORT ================= */
function exportBackup(){
  const payload={
    version:1,
    created:new Date().toISOString(),
    data:enc(JSON.stringify(sites))
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="dashboard-backup.json";
  a.click();
}

function importBackup(file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const o=JSON.parse(r.result);
      sites=JSON.parse(dec(o.data));
      persist();
      alert("Backup restored");
    }catch(e){
      alert("Invalid backup");
    }
  };
  r.readAsText(file);
}

/* ================= RENDER ================= */
function render(){
  tbl.innerHTML=`
  <tr><th>Website</th><th>User ID</th><th>Passwords</th><th>Action</th></tr>`;
  sites.forEach((d,i)=>{
    tbl.innerHTML+=`
    <tr>
      <td>${d.site}</td>
      <td class="copy" onclick="copy('${dec(d.uid)}')">${dec(d.uid)}</td>
      <td class="pass-row">
        Login:
        <input type="password" id="lp${i}" value="${dec(d.pwd1)}" readonly>
        <button class="btn gray" onclick="toggleShow('lp${i}')">Show</button>
        <button class="btn" onclick="copy('${dec(d.pwd1)}')">Copy</button><br>
        ${d.pwd2?`
        Profile:
        <input type="password" id="pp${i}" value="${dec(d.pwd2)}" readonly>
        <button class="btn gray" onclick="toggleShow('pp${i}')">Show</button>
        <button class="btn" onclick="copy('${dec(d.pwd2)}')">Copy</button><br>`:""}
        ${d.pwd3?`
        Txn:
        <input type="password" id="tp${i}" value="${dec(d.pwd3)}" readonly>
        <button class="btn gray" onclick="toggleShow('tp${i}')">Show</button>
        <button class="btn" onclick="copy('${dec(d.pwd3)}')">Copy</button>`:""}
      </td>
      <td>
        <button class="btn green" onclick="editRow(${i})">‚úè Edit</button>
        <button class="btn red" onclick="del(${i})">‚ùå</button>
      </td>
    </tr>`;
  });
}
</script>

</body>
</html>
